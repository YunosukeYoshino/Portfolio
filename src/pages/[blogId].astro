---
import cheerio from "cheerio";
import hljs from "highlight.js";
import Layout from "../layouts/Layout.astro";
import { getBlogs, getBlogDetail } from "../library/microcms";

import "highlight.js/styles/night-owl.css";

// 詳細記事ページの全パスを取得
export async function getStaticPaths() {
  const response = await getBlogs({ fields: ["id"] });
  return response.contents.map((content: any) => ({
    params: {
      blogId: content.id,
    },
  }));
}

//記事の詳細情報を取得
const { blogId } = Astro.params;
const blog = await getBlogDetail(blogId as string);

const $ = cheerio.load(blog.content); // data.bodyはmicroCMSから返されるリッチエディタ部分
$("pre code").each((_: any, elm: any) => {
  const result = hljs.highlightAuto($(elm).text());
  $(elm).html(result.value);
  $(elm).addClass("hljs");
});
// console.log($.html()); // ハイライト済みのHTML
---

<style lang="scss">
  @use "/src/assets/scss/global" as *;

  .l-main__inner {
    @include mq(md) {
      max-width: 80vw;
    }

    margin: auto;
  }
</style>
<Layout title="My first blog with Astro" description="詳細">
  <div class="l-main__inner">
    <div class="p-article__upperInfo">
      <p class="p-article__publishedAt">
        <time>{new Date(blog.publishedAt).toLocaleDateString("ja-JP").replace(/\//g, ".")}</time>
      </p>
      <p class={`p-article__category p-article__category--${blog.category.id}`} data-category-id={blog.category.id}>
        {blog.category.name}
      </p>
    </div>
    <h1 class="p-article__title">{blog.title}</h1>

    <img
      class="p-article__thumbnail"
      src={blog.eyecatch.url}
      width={blog.eyecatch.width}
      height={blog.eyecatch.heigth}
      alt={blog.eyecatch.alt}
      decoding="async"
    />
    <div class="p-article__post" set:html={$.html()} />
  </div>
</Layout>
