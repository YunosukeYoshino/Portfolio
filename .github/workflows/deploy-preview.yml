name: ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: read
  deployments: write

env:
  BUN_VERSION: "latest"
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  test:
    runs-on: ubuntu-latest
    name: ãƒ†ã‚¹ãƒˆ
    steps:
      - name: ğŸ‘©â€ğŸ’» ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      - name: ğŸ”¨ Bunã‚’æœ‰åŠ¹ã«ã™ã‚‹
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
      - name: ğŸ”¨ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: bun install
      - name: ğŸ§ª å‹ãƒã‚§ãƒƒã‚¯
        run: bun run typecheck
      - name: ğŸ§ª ãƒªãƒ³ãƒˆ
        run: bun run lint

  deploy:
    runs-on: ubuntu-latest
    name: ãƒ‡ãƒ—ãƒ­ã‚¤
    needs: test
    steps:
      - name: ğŸ‘©â€ğŸ’» ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      - name: ğŸ”¨ Bunã‚’æœ‰åŠ¹ã«ã™ã‚‹
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
      - name: ğŸ”¨ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: bun install
      - name: ğŸ’ª ãƒ“ãƒ«ãƒ‰
        run: bun run build
        env:
          MICROCMS_SERVICE_DOMAIN: ${{ secrets.MICROCMS_SERVICE_DOMAIN }}
          MICROCMS_API_KEY: ${{ secrets.MICROCMS_API_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          SITE_URL: https://yunosuke-portfolio.pages.dev
      - name: ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          packageManager: bun
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          command: pages deploy out --project-name=yunosuke-portfolio --branch=pr-${{ github.event.pull_request.number }} --commit-dirty=true
      - name: ğŸ“¢ ãƒ‡ãƒ—ãƒ­ã‚¤çµæœ
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract deployment URL from output
          DEPLOYMENT_URL="https://pr-${{ github.event.pull_request.number }}.yunosuke-portfolio.pages.dev"
          # Create QR code URL
          QR_CODE_URL="https://api.qrserver.com/v1/create-qr-code/?size=128x128&data=${DEPLOYMENT_URL}"
          # Post comment to PR
          gh pr comment ${{ github.event.pull_request.number }} --body "## ğŸš€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†

          ### ãƒ‡ãƒ—ãƒ­ã‚¤URL

          [$DEPLOYMENT_URL]($DEPLOYMENT_URL)

          ### QRã‚³ãƒ¼ãƒ‰

          <img width='128px' src='$QR_CODE_URL' alt='QR Code'/>

          <details>
          <summary>ğŸ“‹ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ­ã‚°ã®è©³ç´°</summary>

          ```
          ${{ steps.deploy.outputs.command-output }}
          ```
          </details>
          "
                - name: âŒ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—æ™‚ã®é€šçŸ¥
                  if: failure()
                  env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  run: |
                    gh pr comment ${{ github.event.pull_request.number }} --body "## âŒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—

          ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°ã¯[GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})ã‚’ã”ç¢ºèªãã ã•ã„ã€‚"name: ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰



          on:

            name: ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰

            on:
              pull_request:
                branches:
                  - main
              workflow_dispatch:

            permissions:
              pull-requests: write
              contents: read
              deployments: write

            env:
              BUN_VERSION: 'latest'
              CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

            jobs:
              test:
                runs-on: ubuntu-latest
                name: ãƒ†ã‚¹ãƒˆ
                steps:
                  - name: ğŸ‘©â€ğŸ’» ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
                    uses: actions/checkout@v4
                  - name: ğŸ”¨ Bunã‚’æœ‰åŠ¹ã«ã™ã‚‹
                    uses: oven-sh/setup-bun@v1
                    with:
                      bun-version: ${{ env.BUN_VERSION }}
                  - name: ğŸ”¨ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
                    run: bun install
                  - name: ğŸ§ª å‹ãƒã‚§ãƒƒã‚¯
                    run: bun run typecheck
                  - name: ğŸ§ª ãƒªãƒ³ãƒˆ
                    run: bun run lint

              deploy:
                runs-on: ubuntu-latest
                name: ãƒ‡ãƒ—ãƒ­ã‚¤
                needs: test
                steps:
                  - name: ğŸ‘©â€ğŸ’» ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
                    uses: actions/checkout@v4
                  - name: ğŸ”¨ Bunã‚’æœ‰åŠ¹ã«ã™ã‚‹
                    uses: oven-sh/setup-bun@v1
                    with:
                      bun-version: ${{ env.BUN_VERSION }}
                  - name: ğŸ”¨ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
                    run: bun install
                  - name: ğŸ’ª ãƒ“ãƒ«ãƒ‰
                    run: bun run build
                    env:
                      MICROCMS_SERVICE_DOMAIN: ${{ secrets.MICROCMS_SERVICE_DOMAIN }}
                      MICROCMS_API_KEY: ${{ secrets.MICROCMS_API_KEY }}
                      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
                      SITE_URL: https://yunosuke-portfolio.pages.dev
                  - name: ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤
                    id: deploy
                    uses: cloudflare/wrangler-action@v3
                    with:
                      packageManager: bun
                      accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
                      apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                      command: pages deploy out --project-name=yunosuke-portfolio --branch=pr-${{ github.event.pull_request.number }} --commit-dirty=true
                  - name: ğŸ“¢ ãƒ‡ãƒ—ãƒ­ã‚¤çµæœ
                    if: success()
                    env:
                      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                    run: |
                      # Extract deployment URL from output
                      DEPLOYMENT_URL="https://pr-${{ github.event.pull_request.number }}.yunosuke-portfolio.pages.dev"
                      # Create QR code URL
                      QR_CODE_URL="https://api.qrserver.com/v1/create-qr-code/?size=128x128&data=${DEPLOYMENT_URL}"
                      # Post comment to PR
                      gh pr comment ${{ github.event.pull_request.number }} --body "## ğŸš€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†

            ### ãƒ‡ãƒ—ãƒ­ã‚¤URL

            [$DEPLOYMENT_URL]($DEPLOYMENT_URL)

            ### QRã‚³ãƒ¼ãƒ‰

            <img width='128px' src='$QR_CODE_URL' alt='QR Code'/>

            <details>
            <summary>ğŸ“‹ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ­ã‚°ã®è©³ç´°</summary>

            ```
            ${{ steps.deploy.outputs.command-output }}
            ```
            </details>
            "
                  - name: âŒ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—æ™‚ã®é€šçŸ¥
                    if: failure()
                    env:
                      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                    run: |
                      gh pr comment ${{ github.event.pull_request.number }} --body "## âŒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—

            ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°ã¯[GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})ã‚’ã”ç¢ºèªãã ã•ã„ã€‚"

                  if: failure()

                  env:

                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

                  run: |

                    gh pr comment ${{ github.event.pull_request.number }} --body "## âŒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—



          ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°ã¯[GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})ã‚’ã”ç¢ºèªãã ã•ã„ã€‚"
