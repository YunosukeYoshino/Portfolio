name: ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: read
  deployments: write

env:
  BUN_VERSION: "latest"
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  PREVIEW_SITE_URL: "https://preview-yunosuke-portfolio.pages.dev"
  CLOUDFLARE_PROJECT_NAME: "yunosuke-portfolio"
  PREVIEW_BRANCH_NAME: "preview"

jobs:
  test:
    runs-on: ubuntu-latest
    name: ãƒ†ã‚¹ãƒˆ
    steps:
      - name: ğŸ‘©â€ğŸ’» ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      - name: ğŸ”¨ Bunã‚’æœ‰åŠ¹ã«ã™ã‚‹
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
      - name: ğŸ”¨ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: bun install
      - name: ğŸ§ª å‹ãƒã‚§ãƒƒã‚¯
        run: bun run typecheck
      - name: ğŸ§ª ãƒªãƒ³ãƒˆ
        run: bun run lint

  deploy:
    runs-on: ubuntu-latest
    name: ãƒ‡ãƒ—ãƒ­ã‚¤
    needs: test
    steps:
      - name: ğŸ‘©â€ğŸ’» ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      - name: ğŸ”¨ Bunã‚’æœ‰åŠ¹ã«ã™ã‚‹
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
      - name: ğŸ”¨ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: bun install
      - name: ğŸ’ª ãƒ“ãƒ«ãƒ‰
        run: bun run build
        env:
          MICROCMS_SERVICE_DOMAIN: ${{ secrets.MICROCMS_SERVICE_DOMAIN }}
          MICROCMS_API_KEY: ${{ secrets.MICROCMS_API_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          SITE_URL: ${{ env.PREVIEW_SITE_URL }}
          NEXT_PUBLIC_SITE_URL: ${{ env.PREVIEW_SITE_URL }}
      - name: ğŸš€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          packageManager: bun
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          command: bun x wrangler pages deploy out --project-name=${{ env.CLOUDFLARE_PROJECT_NAME }} --branch=pr-${{ github.event.pull_request.number }} --commit-dirty=true
      - name: ğŸ“¢ ãƒ‡ãƒ—ãƒ­ã‚¤çµæœ
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          text="${{ steps.deploy.outputs.command-output }}"
          url=$(echo "$text" | grep -oP 'https?://[^\s]+' | head -n1)
          if [ -z "$url" ]; then
            echo "ğŸš¨ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ URL ãŒå‡ºåŠ›ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            exit 1
          fi
          qr_code_url="https://qr.digima.workers.dev/?url=$url"
          gh pr comment ${{ github.event.pull_request.number }} --body "<p><a href='$url'>$url</a></p><img width='128px' src='$qr_code_url'/><details><summary>ãƒ­ã‚°ã®è©³ç´°</summary>${{ steps.deploy.outputs.command-output }}</details>"
